### 缓存查询

#### 基本流程

- 查缓存
  - 缓存命中，返回结果
  - 缓存未命中：
    - 查询数据库
      - 数据库命中，写回缓存，返回结果
      - 未命中：返回fail

#### 缓存与数据库不一致问题

- 解决方案

  - 低一致性要求（数据发生改变的频率较低）：使用Redis自带的内存淘汰机制
  - 高一致性要求：主动更新，超时剔除方案兜底

- 主动更新

  - 删除缓存 or 修改缓存？

    删除缓存。修改缓存做了100次操作，但在此过程中如果没有发生读操作的话，那么99次都是浪费。而删除缓存则不会造成额外的时间开销。

  - 如何保证缓存与数据库的操作同步？

    - 单体：事务
    - 分布式：TCC事务

  - 先操作缓存 or 先操作数据库？

    - 先操作数据库：发生线程不安全的情况一般只发生在缓存失效的情况下，且此情况发火说呢过的概率较低，故先操作数据库

#### 缓存穿透

缓存穿透式数据在数据库中和缓存中都不存在的现象

常见的解决方案有：

- 缓存空对象：在数据库没有查询到所需要的数据时，存一个null到缓存中
  - 优点：操作简单方便
  - 缺点：
    - 额外的内存开销：可以通过设置较小的TTL减轻，超时清理
    - 短期内的数据不一致：较小的TTL，或是主动更新策略
- 布隆过滤器：在缓存与客户端间加一个布隆过滤器进行过滤

#### 缓存雪崩

缓存雪崩是指在某段时间内key大量失效(TTL过期)，或Redis服务器宕机，导致大量请求直接到达数据库（后者为全部请求），给数据库造成过大压力的现象。

常见的解决方案：

- 给key赋随机的TTL 借助随机数
- 利用Redis集群提高服务的可用性
- 给缓存业务添加限流降级策略？
- 给业务添加多级缓存